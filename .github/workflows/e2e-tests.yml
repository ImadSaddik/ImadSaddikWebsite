name: E2E tests

on:
  workflow_call:

env:
  MEILISEARCH_MASTER_KEY: "aStrongMasterKeyForTestingPurposes"
  MEILISEARCH_URL: "http://localhost:7700"
  MEILISEARCH_INDEX_NAME: "articles_test"

jobs:
  tests:
    name: Run E2E tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Check out repository
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"
          cache: "pip"

      - name: Install backend dependencies
        working-directory: ./backend
        run: pip install -r requirements.txt

      - name: Download Meilisearch binary
        working-directory: ./backend
        run: |
          curl -L https://install.meilisearch.com | sh
          chmod +x meilisearch

      - name: Start Meilisearch
        working-directory: ./backend
        run: |
          ./meilisearch --master-key="${MEILISEARCH_MASTER_KEY}" &
          echo "Waiting for Meilisearch to start..."
          for i in {1..30}; do
            if curl -s http://localhost:7700/health | grep -q "available"; then
              echo "Meilisearch is ready!"
              break
            fi
            echo "Attempt $i: Meilisearch not ready yet..."
            sleep 1
          done
          if ! curl -s http://localhost:7700/health | grep -q "available"; then
            echo "Meilisearch failed to start after 30 attempts"
            exit 1
          fi

      - name: Start backend server
        working-directory: ./backend
        run: |
          uvicorn main:app --host 0.0.0.0 --port 8000 &
          echo "Waiting for backend to start..."
          for i in {1..30}; do
            if curl -s http://localhost:8000/api/health | grep -q "ok"; then
              echo "Backend is ready!"
              break
            fi
            echo "Attempt $i: Backend not ready yet..."
            sleep 1
          done
          if ! curl -s http://localhost:8000/api/health | grep -q "ok"; then
            echo "Backend failed to start after 30 attempts"
            exit 1
          fi
        env:
          MEILISEARCH_URL: ${{ env.MEILISEARCH_URL }}
          MEILISEARCH_MASTER_KEY: ${{ env.MEILISEARCH_MASTER_KEY }}
          MEILISEARCH_INDEX_NAME: ${{ env.MEILISEARCH_INDEX_NAME }}

      - name: Seed E2E test data
        working-directory: ./backend
        run: python -m tests.test_data
        env:
          MEILISEARCH_URL: ${{ env.MEILISEARCH_URL }}
          MEILISEARCH_MASTER_KEY: ${{ env.MEILISEARCH_MASTER_KEY }}
          MEILISEARCH_INDEX_NAME: ${{ env.MEILISEARCH_INDEX_NAME }}

      - name: Set up pnpm
        uses: pnpm/action-setup@v4
        with:
          version: "10"

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "22"
          cache: "pnpm"
          cache-dependency-path: frontend/pnpm-lock.yaml

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: pnpm install

      - name: Create frontend .env file
        working-directory: ./frontend
        run: |
          echo "VITE_API_BASE_URL=http://localhost:8000" > .env
          echo "BASE_URL=http://localhost:8080" >> .env

      - name: Get Playwright version
        id: playwright-version
        working-directory: ./frontend
        run: echo "version=$(pnpm list @playwright/test --json | jq -r '.[0].devDependencies["@playwright/test"].version')" >> $GITHUB_OUTPUT

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ steps.playwright-version.outputs.version }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Install Playwright browsers (if no cache)
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        working-directory: ./frontend
        run: pnpm exec playwright install --with-deps chromium firefox

      - name: Install Playwright dependencies (if cache hit)
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        working-directory: ./frontend
        run: pnpm exec playwright install-deps chromium firefox

      - name: Build frontend
        working-directory: ./frontend
        run: pnpm run build

      - name: Run E2E tests
        working-directory: ./frontend
        run: pnpm run test:e2e
        env:
          CI: true

      - name: Upload Playwright report
        uses: actions/upload-artifact@v5
        if: ${{ !cancelled() }}
        with:
          name: playwright-report
          path: frontend/playwright-report/
          retention-days: 30

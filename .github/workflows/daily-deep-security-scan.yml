name: Daily deep security scan (DAST)

on:
  schedule:
    - cron: "0 6 * * *"
  workflow_dispatch:

jobs:
  deep_scan:
    name: Full OWASP ZAP scan
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      MEILISEARCH_MASTER_KEY: "aStrongMasterKeyForTestingPurposes"
      MEILISEARCH_URL: "http://localhost:7700"
      MEILISEARCH_INDEX_NAME: "articles_test"
      ENVIRONMENT: "development"
    steps:
      - name: Check out repository
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"
          cache: "pip"

      - name: Install backend dependencies
        working-directory: ./backend
        run: pip install -r requirements.txt

      - name: Download Meilisearch binary
        working-directory: ./backend
        run: |
          curl -L https://install.meilisearch.com | sh
          chmod +x meilisearch

      - name: Start Meilisearch
        working-directory: ./backend
        run: |
          ./meilisearch --master-key="${MEILISEARCH_MASTER_KEY}" &
          echo "Waiting for Meilisearch to start..."
          for i in {1..30}; do
            if curl -s http://localhost:7700/health | grep -q "available"; then
              echo "Meilisearch is ready!"
              break
            fi
            echo "Attempt $i: Meilisearch not ready yet..."
            sleep 1
          done
          if ! curl -s http://localhost:7700/health | grep -q "available"; then
            echo "Meilisearch failed to start after 30 attempts"
            exit 1
          fi

      - name: Start backend server
        working-directory: ./backend
        run: |
          uvicorn main:app --host 0.0.0.0 --port 8000 &
          echo "Waiting for backend to start..."
          for i in {1..30}; do
            if curl -s http://localhost:8000/api/health | grep -q "ok"; then
              echo "Backend is ready!"
              break
            fi
            echo "Attempt $i: Backend not ready yet..."
            sleep 1
          done
          if ! curl -s http://localhost:8000/api/health | grep -q "ok"; then
            echo "Backend failed to start after 30 attempts"
            exit 1
          fi
        env:
          MEILISEARCH_URL: ${{ env.MEILISEARCH_URL }}
          MEILISEARCH_MASTER_KEY: ${{ env.MEILISEARCH_MASTER_KEY }}
          MEILISEARCH_INDEX_NAME: ${{ env.MEILISEARCH_INDEX_NAME }}
          ENVIRONMENT: ${{ env.ENVIRONMENT }}

      - name: Seedtest data
        working-directory: ./backend
        run: python -m tests.test_data

      - name: Set up pnpm
        uses: pnpm/action-setup@v4
        with:
          version: "10"

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "22"
          cache: "pnpm"
          cache-dependency-path: frontend/pnpm-lock.yaml

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: pnpm install

      - name: Create frontend .env file
        working-directory: ./frontend
        run: |
          echo "VITE_API_BASE_URL=http://localhost:8000" > .env
          echo "BASE_URL=http://localhost:8080" >> .env

      - name: Build frontend
        working-directory: ./frontend
        run: pnpm build

      - name: Start frontend (Production preview)
        working-directory: ./frontend
        run: |
          nohup pnpm preview --host &
          echo "Waiting for frontend to start..."
          for i in {1..30}; do
            if curl -s http://localhost:8080/ | grep -q "<title>Imad Saddik</title>"; then
              echo "Frontend is ready!"
              break
            fi
            echo "Attempt $i: Frontend not ready yet..."
            sleep 1
          done
          if ! curl -s http://localhost:8080/ | grep -q "<title>Imad Saddik</title>"; then
            echo "Frontend failed to start after 30 attempts"
            exit 1
          fi

      - name: Run ZAP full scan
        uses: zaproxy/action-full-scan@v0.13.0
        with:
          target: "http://localhost:8080"
          rules_file_name: ".github/zap-rules.tsv"
          allow_issue_writing: false
          fail_action: true
